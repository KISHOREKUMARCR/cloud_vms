{% extends 'templates/main_base.html' %}
{% load static %}

{% block title %}Add Video File{% endblock %}
<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
<script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>

{% block content %}

<div class="container-xxl flex-grow-1 container-p-y">
  <form class="browser-default-validation" id="VideoUpload" method="post" enctype="multipart/form-data">
    {% csrf_token %}
  <h4 class="py-3 breadcrumb-wrapper mb-4">
    <span class="text-muted fw-light">COS AI - Client /</span> New Video Upload
      
  </h4>
  <div class="row">
  <div class="col-md-12">
  <div class="card mb-4">
        <h5 class="card-header">Project Location selection</h5>
  <div class="card-body">
  <div class="form-group">  
  <div class="row">
    <!-- Form controls -->
  
    <div class="col-md-4" >      
          <div class="mb-3" >
            <label for="exampleFormControlInput1" class="form-label" >Select Company</label>
            {% comment %} <select class="form-select CompanyName" id="basic-default-company" name="CompanyName" required>
              <option value="4" data-icon="bx bxl-codepen">Technical Consultancy Services (TCS)                 
              </option>
                     
          </select> {% endcomment %}

          {% comment %} {% if   usercomp == 'COSAI' %} {% endcomment %}
          <select class="form-select CompanyName" id="basic-default-company" name="CompanyName" required>
            <option value="">List of Company</option> 
          {% comment %} {% endif %} {% endcomment %}
            {% for comp in get_user_company  %}
            <option value="{{comp.id}}" data-icon="bx bxl-codepen">{{comp.name}}                  
            </option>
            {% endfor %}            
        </select>
          </div>
        </div>
        <div class="col-md-4" >    
          <div class="mb-3">
            <label for="exampleFormControlReadOnlyInput1" class="form-label">Select Project</label>
            {% comment %} <select class="form-select ProjectName" id="basic-default-project" name="ProjectName" >  
              <option value="3" data-icon="bx bxl-codepen">Traffic Survey - Video Upload Mode                
              </option>            
            </select> {% endcomment %}
           
            <select class="form-select ProjectName" id="basic-default-project" name="ProjectName" >    
              {% if project_count == 1 %}
                {% for proj in get_user_project  %}
                <option value="{{proj.id}}" data-icon="bx bxl-codepen">{{proj.name}}                  
                </option>
                {% endfor %}   
              {% endif %}            
            </select>
          </div>
        </div>
        <div class="col-md-4" >  
          <div class="mb-3">
            <label for="exampleFormControlReadOnlyInputPlain1" class="form-label">Select Location</label>
            {% comment %} <select class="form-select  StationName" id="basic-default-location"  name="StationName" >
              <option value="4" data-icon="bx bxl-codepen">General - Video Upload Mode
              </option>  
            </select> {% endcomment %}
            <select class="form-select  StationName" id="basic-default-location"  name="StationName" ></select>
           
          </div>
        </div>
       
    
 
      <!-- Form controls -->
     
          <div class="col-md-2" >  
            <div class="mb-3">
              <label for="exampleFormControlReadOnlyInputPlain1" class="form-label">Video File Format</label>
              <select class="form-select  VideoFormat" id="basic-default-VideoFormat"  name="VideoFormat" >
              
                  {% comment %} <option selected="" value="1" data-icon="bx bxl-codepen"></option> {% endcomment %}
                  {% for vf in VideoFormat  %}
                  <option value="{{vf.id}}" data-icon="bx bxl-codepen">{{vf.vtype}}                  
                  </option>
                
                  {% endfor %}
              
        
              </select>
            </div>
          </div>

           <div class="col-md-3" >    
            <div class="mb-3">
              <label for="exampleFormControlReadOnlyInput1" class="form-label">Remarks</label>
              <input
              type="text"
              id="Remarks"
              name="Remarks"
              class="form-control"
              placeholder=""
              value="Videos Files Upload"
              required
            />
            </div>
          </div>
          </div>         {% comment %}  class="form-group"> {% endcomment %}

         <div class="card mb-4" id="div1">
        <h5 class="card-header">* Upload One Hour Video Only</h5>
         <div class="card-body">
          <div class="row">
          <div class="col-md-3">  
            <div class="mb-3">
              <label for="exampleFormControlReadOnlyInputPlain1" class="form-label">Video Taken Date </label>
              <input
              type="date"
              id="VideoTakenDate"
              name="VideoTakenDate"
              class="form-control"
              placeholder=""
              required
          />
            </div>
          </div>  
          <div class="col-md-3">  
            <div class="mb-3">
              <label for="exampleFormControlReadOnlyInputPlain1" class="form-label">Start Time (HH:MM)</label>
              <input
              type="Time"
              id="VideoStartTime"
              name="VideoStartTime"
              class="form-control"
              placeholder=""
              required
          />
            </div>
          </div>  
          <div class="col-md-3">      
            <div class="mb-3">
              <label for="exampleFormControlInput1" class="form-label">End Time (HH:MM)</label>
              <input
                        type="Time"
                        id="VideoEndTime"
                        name="VideoEndTime"
                        class="form-control"
                        placeholder=""
                        required
                    />
            </div>
          </div> 
          <div >
          <div class="row">
           <div class="col-md-3"> 
            
                <label>Choose one:</label><br>
                  <input type="radio" id="urlpathradio" name="choice" value="urlpathradio" onchange="toggleOption()">
                  <label for="urlpathradio">URL Path</label>
                  <br>
                  <input type="radio" id="fileuploadradio" name="choice" value="fileuploadradio" onchange="toggleOption()">
                  <label for="fileuploadradio">File Upload</label>
                </div> 
                    
                {% comment %} <div class="col-md-3"> {% endcomment %}
                  <div class="form-group" >
                        <label for="urlpathlabel" id="urlpathlabel" style="display: none" class="hidden">URL Path</label>
                        <input
                                  type="Text"
                                  id="urlpath"
                                  style="display: none"
                                  name="urlpath"
                                  class="hidden"
                                  placeholder=""
                                  requireds
                            />
                        {% comment %} <input type="submit" value="Save" id="saveurl" style="display: none" class="btn btn-primary" >  </div> </div> {% endcomment %}
                    </div>      
                    {% comment %} <div class="col-md-3"> {% endcomment %}
                    <div class="form-group" >
                      <label id="fileuploadlabel" style="display: none">Select ***ONE HOUR*** video file .</label>
                      <input type="file" id="fileupload" style="display: none" placeholder="Select file">
                      <br>
                      <input type="submit" value="Save" name="submitbtn" id="submit" style="display: none" class="btn btn-success">  </div> </div>
                    </div>
                     </div> 
                  </div> 
               
        </div>  
                 

      </div>
      <div id="uploaded_files"></div>
      <div class="row">
        <!-- Form controls -->
          
            
        </div>
        <div class="row">
          <!-- Form controls -->

               
          </div>
</div>

  </div>
  </div>


<!-- / Content -->



<div class="content-backdrop fade"></div>
</div>
<!-- Content wrapper -->
</form>
</div>  

</div>

{%endblock%}

<!-- style css -->
<!-- script tag -->
{% block script %}


<script>

 // basic-default-company
 console.log('$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$')
    //   Select company
 $('#basic-default-company').on('click', function (e) {
 
        var optionSelected = $("option:selected", this);
        var id = this.value;
       
        if (id != ''){
          $.ajax({
            url: "{% url 'get_projects' %}",
            method: 'get',
            data: {
                'id':id,
            },
            dataType: 'json',
            success: function(data){
              console.log(data)
              if(1){
                var txt =  '<select class="form-select" id="basic-default-project" ><option selected="" disabled>...</option>'
           
                  data.data.forEach(function(item){

                  txt += '<option  value='+ item.id +'><a href=1>'+ item.name +'</a></option>'
                });
                
                
                txt += '</select>'
                $('#basic-default-project').html(txt)
               
                // txt += '</div>'
                // $('#list_camera').html(txt)
                
                // $('html,body').animate({scrollTop:distance},500);
              }
            }
          })
  
        }
        
    });

     //   Select project
 $('#basic-default-project').on('change', function (e) {
        
        var optionSelected = $("option:selected", this);
        var id = this.value;
        console.log('$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$', id)
        if (id != ''){
          $.ajax({
            url: "{% url 'get_stations' %}",
            method: 'get',
            data: {
                'id':id,
            },
            dataType: 'json',
            success: function(data){
              if(1){
                var txt =  '<select class="form-select" id="basic-default-location" ><option selected="" disabled>...</option>'
           
                  data.data.forEach(function(item){

                  txt += '<option  value='+ item.id +'><a href=1>'+ item.name +'</a></option>'
                });
                txt += '</select>'
                $('#basic-default-location').html(txt)
               
                // txt += '</div>'
                // $('#list_camera').html(txt)
                
                // $('html,body').animate({scrollTop:distance},500);
              }
            }
          })
  
        }
        
    });
  $('#basic-default-company').on('change', function (e) {
 
    var optionSelected = $("option:selected", this);
    var id = this.value;
    if (id != ''){
          $.ajax({
           
            data: {
                'id':id,
            },
            dataType: 'json',
            success: function(data){
              console.log(data)}
            })
          }

  });

  $('#basic-default-LICate').on('change', function (e) {
 
 var optionSelected = $("option:selected", this);
 var id = this.value;
 if (id != ''){
       $.ajax({
        
         data: {
             'id':id,
         },
         dataType: 'json',
         success: function(data){
           console.log(data)}
         })
       }

});
$('#basic-default-VideoFormat').on('change', function (e) {
 
 var optionSelected = $("option:selected", this);
 var id = this.value;
 if (id != ''){
       $.ajax({
        
         data: {
             'id':id,
         },
         dataType: 'json',
         success: function(data){
           console.log(data)}
         })
       }

});

 // file extn check
 document.getElementById('fileupload').addEventListener('change', function() {
  var fileName = this.value;
  var fileExtension = fileName.split('.').pop().toUpperCase();

  console.log("fileExtension : ",   fileExtension  )

  var dropdown = document.getElementById('basic-default-VideoFormat');

  // Get the selected index
  var selectedIndex = dropdown.selectedIndex;

  // Get the text of the selected option
  var selectedOptionText = dropdown.options[selectedIndex].text;

  if (fileExtension !=  selectedOptionText.toUpperCase() )
  { alert('Invalid file extension found. Upload Valid Video file');
  this.value=""; }
   
});
// java script --- video upload ---------

$('#submit').on('click', (event) => {
  console.log("INSIDE UPLOAD SUBMIT CALL")
  event.preventDefault();
  
  
  result=validation_check()

    
   if (result.valid) {                   
   var uploader = new FileUpload(document.querySelector('#fileupload'))
          
    console.log(document.querySelector('#fileupload'));
    uploader.upload();}
    else {
      alert(result.message);
    }
 

    });

class FileUpload {

  constructor(input) {
      this.input = input
      this.max_length = 1024 * 1024 * 50;
  }

 

  create_progress_bar() {
      var progress = `<div class="file-icon">
                          <i class="fa fa-file-o" aria-hidden="true"></i>
                      </div>
                      <div class="file-details">
                          <p class="filename"></p>
                          <small class="textbox"></small>
                          <div class="progress" style="margin-top: 5px;">
                              <div class="progress-bar bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                              </div>
                          </div>
                      </div>`
      document.getElementById('uploaded_files').innerHTML = progress
  }
 
  upload() {

    console.log("INSIDE UPLOAD FUNCTION : " ,document.getElementsByName('choice'));
    
    var radioButtons = document.getElementsByName('choice');
    console.log(" selected radio button : " ,radioButtons[0].checked," ," ,radioButtons[1].checked);
    if (radioButtons[0].checked) {
      console.log("URL path ");
      var starttime= $('#VideoStartTime').val(); 
      var endtime= $('#VideoEndTime').val(); 
      var videodate = $('#VideoTakenDate').val(); 

      var company= $('#basic-default-company').val(); 
      var project= $('#basic-default-project').val(); 
      var location= $('#basic-default-location').val(); 
        
      var videoformat= $('#basic-default-VideoFormat').val(); 
      var remarks= $('#Remarks').val(); 
      var urlpath=$('#urlpath').val();

      var formData = new FormData();
      formData.append('videodate',videodate)
      formData.append('starttime',starttime)
      formData.append('endtime',endtime)
      formData.append('CompanyName',company)
      formData.append('ProjectName',project)
      formData.append('StationName',location)
      formData.append('VideoFormat',videoformat)
      formData.append('Remarks',remarks)
      formData.append('urlpath',urlpath)
      console.log("Form Data : ",formData)
      $.ajaxSetup({
        headers: {
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    });
      $.ajax({
          url: '',
          type: 'POST',
          dataType: 'json',
          cache: false,
          processData: false,
          contentType: false,
          data: formData,
          error: function (e) {
            console.log("error",e)
            alert(e.data);
          },
          success: function (e) {
            console.log("success",e)
            alert(e.data);
            $("input[type=date][name$=VideoTakenDate]").val('');
            $("input[type=time][name$=VideoStartTime]").val('');
            $("input[type=time][name$=VideoEndTime]").val('');
            $("input[type=text][name$=urlpath]").val('');
          }
      })

    }
    else 
    {
      console.log('filename upload')
       this.create_progress_bar();
      this.initFileUpload();
    }
     
  }

  initFileUpload() {
      this.file = this.input.files[0];
      this.upload_file(0, null);
     
     
  }

  //upload file
  upload_file(start, model_id) {
    
    
      var end;
      var self = this;


    console.log('filename', this.file.name)
   
    var newName = ""
    var starttime= $('#VideoStartTime').val(); 
    var endtime= $('#VideoEndTime').val(); 
    var videodate = $('#VideoTakenDate').val(); 

    var company= $('#basic-default-company').val(); 
    var project= $('#basic-default-project').val(); 
    var location= $('#basic-default-location').val(); 
      
    var videoformat= $('#basic-default-VideoFormat').val(); 
    var remarks= $('#Remarks').val(); 
    var urlpath ='NA'
    var formData = new FormData();
      formData.append('videodate',videodate)
      formData.append('starttime',starttime)
      formData.append('endtime',endtime)
      formData.append('CompanyName',company)
      formData.append('ProjectName',project)
      formData.append('StationName',location)
      formData.append('VideoFormat',videoformat)
      formData.append('Remarks',remarks)
      formData.append('urlpath',urlpath)
      console.log("Path",model_id)
      var existingPath = model_id;
      console.log("existingPath",existingPath)
      var nextChunk = start + this.max_length + 1;
      var currentChunk = this.file.slice(start, nextChunk);
      var uploadedChunk = start + currentChunk.size
    
      if (uploadedChunk > this.file.size) {
          end = 1;
      } else {
          end = 0;
      }
      
     var fileextnloc= this.file.name.lastIndexOf('.')
     var fileextn=this.file.name.substring(fileextnloc,) 

     var videotime= starttime.replace(':','')
     console.log("fileextn :", fileextn)
     //if fileextn ==  videoformat
      newName=newName.concat(company,"_",project,"_",location,"_",videodate,"_",videotime,fileextn)
      console.log("newName newName :",newName)

      formData.append('file', currentChunk)
      formData.append('filename', newName)

      $('.filename').text(newName)


      $('.textbox').text("Uploading file")

      $("#submit").prop({disabled: true});




      formData.append('end', end)
      formData.append('existingPath', existingPath)
      // console.log("existingPath@222",existingPath)
      formData.append('nextSlice', nextChunk)
      


      $.ajaxSetup({
          headers: {
              "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
          }
      });
      $.ajax({
          xhr: function () {
              var xhr = new XMLHttpRequest();
              xhr.upload.addEventListener('progress', function (e) {
                  if (e.lengthComputable) {
                      if (self.file.size <= self.max_length) {
                          var percent = Math.round((e.loaded / e.total) * 100);
                      } else {
                          var percent = Math.round((uploadedChunk / self.file.size) * 100);
                      }
                      $('.progress-bar').css('width', percent + '%')
                      $('.progress-bar').text(percent + '%')
                  }
              });
              console.log("xhr function",xhr)
              return xhr;
          },

          url: '',
          type: 'POST',
          dataType: 'json',
          cache: false,
          processData: false,
          contentType: false,
          data: formData,
          error: function (xhr) {
              alert(xhr.ResponseText);
              console.log("error part")
              $('#fileupload input').val("");
          },
          success: function (res) {
              console.log("RES RES",res)

              if (nextChunk <= self.file.size) {
                  // upload file in chunks

                  existingPath = res.existingPath
                  console.log("Existing path :",existingPath)
                  self.upload_file(nextChunk, existingPath);
              } else {
                  // upload complete
                 
                  console.log("else part check file size",res.data)
                  $('.textbox').text(res.data);
                  {% comment %} VideoUpload.reset()    $("#div1").empty();{% endcomment %}
                
                
                  if (res.data="File already Exists")
                       {  
                        alert("Saved successfully")
                       
                      }
                  
                  else { 
                       alert(res.data)}
                  $('.textbox').text("");
                  document.getElementById('uploaded_files').innerHTML=""
                  $("#submit").prop({disabled: false});
                                     
                  
                  $("input[type=date][name$=VideoTakenDate]").val('');
                  $("input[type=time][name$=VideoStartTime]").val('');
                  $("input[type=time][name$=VideoEndTime]").val('');
                 
              }
          }
      

         
      });
  };
}

// validation check
function validation_check(){
  var result = {
    valid: true,
    message: ""
  };

  if($('#VideoTakenDate').val()  == '')
    { result.message="Enter Video Taken Date"
      result.valid=false
  }
  var currentDate = new Date();
  var videoTakenDate = new Date($('#VideoTakenDate').val());
  console.log('current date & VideoDate: ',currentDate,videoTakenDate)
  if(videoTakenDate > currentDate)
    { result.message="Enter Proper Video Taken Date"
    result.valid=false} 
      
  if ($('#VideoStartTime').val()  == '') 
  { result.message="Enter Video Start Time" 
  result.valid=false}
   
  if ($('#VideoStartTime').val()  == '' ) 
  {result.message="Enter Video End Time"
  result.valid=false}
  
  if( $('#VideoStartTime').val() >=  $('#VideoEndTime').val() ) 
   { result.message="Please check Video start Time and End Time" 
   result.valid=false }
    // Convert time strings to Date objects for proper comparison
    var startTime = new Date('1970-01-01 ' + $('#VideoStartTime').val());
    var endTime = new Date('1970-01-01 ' + $('#VideoEndTime').val());
  // Calculate the time difference in milliseconds
  var timeDifference = endTime - startTime;
  console.log("timeDifference :",timeDifference)
  // Check if the time difference is exactly 1 hour
  if (timeDifference !== 60 * 60 * 1000) {
      result.message = "The time difference between Video Start Time and End Time should be exactly 1 hour";
      result.valid = false;
  }
   return result;
  }
// toggleOption

function toggleOption() {
  
  var textOption = document.getElementById('urlpath');
 // console.log("calling toggleOption",textOption);
  var labelOption = document.getElementById('urlpathlabel');
  //var urlbuttonOption=document.getElementById('saveurl') ;
  var fileOption = document.getElementById('fileupload');
  var uploadlabelOption = document.getElementById('fileuploadlabel');
  var buttonOption = document.getElementById("submit");
  var radioButtons = document.getElementsByName('choice');

  //console.log("selected fileOption :", fileOption)

  if (radioButtons[0].checked) {
    //console.log("urlpath selected :",textOption)
    textOption.style.display = 'block';
    labelOption.style.display = 'block';
    //urlbuttonOption.style.display = 'block';
    fileOption.style.display = 'none';
    uploadlabelOption.style.display = 'none';
    buttonOption.style.display = 'block';
  } else if (radioButtons[1].checked) {
      //console.log("fileupload selected")
      textOption.style.display = 'none';
      labelOption.style.display = 'none';
     // urlbuttonOption.style.display = 'none';
      fileOption.style.display = 'block';
      uploadlabelOption.style.display = 'block';
      buttonOption.style.display = 'block';


  }
} 

// script.js


</script>

{% endblock %}

