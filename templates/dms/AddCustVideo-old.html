{% extends 'templates/main_base.html' %}
{% load static %}

{% block title %}Add Video File{% endblock %}
<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
<script src='https://code.jquery.com/jquery-3.2.1.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
{% block content %}

<div class="container-xxl flex-grow-1 container-p-y">
  <form class="browser-default-validation" id="VideoUpload" method="post" enctype="multipart/form-data">
    {% csrf_token %}
  <h4 class="py-3 breadcrumb-wrapper mb-4">
    <span class="text-muted fw-light">COS AI - Forms /</span> Traffic Video Uploader
  </h4>
  <div class="row">
    <div class="col-md-12">
      <div class="card mb-4">
        <h5 class="card-header">* Upload One Hour Video Only</h5>
        <div class="card-body">
<div class="row">
    <!-- Form controls -->
    <div class="col-md-3" hidden>      
          <div class="mb-3" >
            <label for="exampleFormControlInput1" class="form-label" >Select Company</label>
            <select class="form-select CompanyName" id="basic-default-company" name="CompanyName" required>
              <option value="4" data-icon="bx bxl-codepen">Technical Consultancy Services (TCS)                 
              </option>
                     
          </select>
          </div>
        </div>
        <div class="col-md-3" hidden>    
          <div class="mb-3">
            <label for="exampleFormControlReadOnlyInput1" class="form-label">Select Project</label>
            <select class="form-select ProjectName" id="basic-default-project" name="ProjectName" >  
              <option value="3" data-icon="bx bxl-codepen">Traffic Survey - Video Upload Mode                
              </option>            
            </select>
          </div>
        </div>
        <div class="col-md-3" hidden>  
          <div class="mb-3">
            <label for="exampleFormControlReadOnlyInputPlain1" class="form-label">Select Location</label>
            <select class="form-select  StationName" id="basic-default-location"  name="StationName" >
              <option value="4" data-icon="bx bxl-codepen">General - Video Upload Mode
              </option>  
            </select>
           
          </div>
        </div>
        <div class="col-md-3" hidden>  
          <div class="mb-3">
            <label for="exampleFormControlReadOnlyInputPlain1" class="form-label">Camera No/ID</label>
            <input
                          type="text"
                          class="form-control"
                          id="CameraNo"
                          name="CameraNo"
                          placeholder="Camera No/ID (Optional)"
                          aria-describedby="defaultFormControlHelp"
                          value="1"
            />
          </div>
        </div>           
    </div>
    <div class="row">
      <!-- Form controls -->
      <div class="col-md-3" hidden>      
            <div class="mb-3">
              <label for="exampleFormControlInput1" class="form-label">Select Camera Model</label>
              <select class="form-select CModel" id="basic-default-cModel" name="CModel">
                
                  <option selected="" value="1" data-icon="bx bxl-codepen"></option>
               
            
              </select>
            </div>
          </div>
          <div class="col-md-3" hidden>    
            <div class="mb-3">
              <label for="exampleFormControlReadOnlyInput1" class="form-label">Camera Height</label>
              <input
                      type="text"
                      id="CHeight"
                      name="CHeight"
                      class="form-control"
                      placeholder=""
                      value="4.5"
                      required
                  />
            </div>
          </div>
          <div class="col-md-3" hidden>  
            <div class="mb-3">
              <label for="exampleFormControlReadOnlyInputPlain1" class="form-label">Camera View</label>
              <input
                    type="text"
                    id="CView"
                    name="CView"
                    class="form-control"
                    placeholder=""
                    value="side"
                    required
              />
            </div>
          </div>
          <div class="col-md-3">  
            <div class="mb-3">
              <label for="exampleFormControlReadOnlyInputPlain1" class="form-label">Video Taken Date </label>
              <input
              type="date"
              id="VideoTakenDate"
              name="VideoTakenDate"
              class="form-control"
              placeholder=""
              required
          />
            </div>
          </div>  
          <div class="col-md-3">  
            <div class="mb-3">
              <label for="exampleFormControlReadOnlyInputPlain1" class="form-label">Start Time (HH:MM)</label>
              <input
              type="Time"
              id="VideoStartTime"
              name="VideoStartTime"
              class="form-control"
              placeholder=""
              required
          />
            </div>
          </div>  
          <div class="col-md-3">      
            <div class="mb-3">
              <label for="exampleFormControlInput1" class="form-label">End Time (HH:MM)</label>
              <input
                        type="Time"
                        id="VideoEndTime"
                        name="VideoEndTime"
                        class="form-control"
                        placeholder=""
                        required
                    />
            </div>
          </div> 
          {% comment %} 
          <div class="col-md-3" >      
            <div class="mb-3">
              <label for="exampleFormControlInput1" class="form-label">Upload</label>
              <input type="file" id="VideoFile" name="VideoFile" class="form-control"  required/>
            </div>
          </div> {% endcomment %}
          <div class="col-md-3">
          <div class="form-group">
            <label>Select ***ONE HOUR*** video file to upload.</label>
            <input type="file" class="form-control" id="fileupload" placeholder="Select file">
            <br>
            <input type="submit" value="Upload" id="submit" class="btn btn-success">  </div> </div>
           </div>
          </div>
          
                 

      </div>
      <div id="uploaded_files"></div>
      <div class="row">
        <!-- Form controls -->
       
            <div class="col-md-3" hidden>    
              <div class="mb-3">
                <label for="exampleFormControlReadOnlyInput1" class="form-label">Light Intensity</label>
                <select class="form-select  LICate" id="basic-default-LICate"  name="LICate" >
                 
                    <option selected="" value="1" data-icon="bx bxl-codepen"></option>
                
                
          
                </select>
              </div>
            </div>
            <div class="col-md-3" hidden>  
              <div class="mb-3">
                <label for="exampleFormControlReadOnlyInputPlain1" class="form-label">Video File Format</label>
                <select class="form-select  VideoFormat" id="basic-default-VideoFormat"  name="VideoFormat" >
                
                    <option selected="" value="1" data-icon="bx bxl-codepen"></option>
                 
                
          
                </select>
              </div>
            </div>
            {% comment %} 
            <div class="col-md-3" hidden>  
              <div class="mb-3">
                <label for="exampleFormControlReadOnlyInputPlain1" class="form-label">File Name</label>
                <input
                type="text"
                id="FileName"
                name="FileName"
                class="form-control"
                placeholder=""
              
              />
              </div>
            </div>   {% endcomment %}
            
            
        </div>
        <div class="row">
          <!-- Form controls -->
        
              <div class="col-md-3" hidden>    
                <div class="mb-3">
                  <label for="exampleFormControlReadOnlyInput1" class="form-label">Remarks</label>
                  <input
                  type="text"
                  id="Remarks"
                  name="Remarks"
                  class="form-control"
                  placeholder=""
                  value="test"
                  required
                />
                </div>
              </div>
              {% comment %} <div class="col-md-3">  
                <div class="mb-3">
                  <label for="exampleFormControlReadOnlyInput1" class="form-label">&nbsp;</label>
                  <button type="submit" class="form-control btn btn-primary">Submit</button>
                
                </div>
              </div>
              <div class="col-md-3">  
                <div class="mb-3">
                  <label for="exampleFormControlReadOnlyInput1" class="form-label">&nbsp;</label>
                  <input type="button"  class="form-control btn btn-secondary" value="reset" id="resetBtn" onClick="this.form.reset()" />
                </div>
              </div>       {% endcomment %}
               
          </div>
</div>

  </div>
  </div>


<!-- / Content -->



<div class="content-backdrop fade"></div>
</div>
<!-- Content wrapper -->
</form>
</div>  

</div>

{%endblock%}
<!-- script tag -->
{% block script %}


<script>

 // basic-default-company
 console.log('$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$')
    //   Select company
 $('#basic-default-company').on('click', function (e) {
 
        var optionSelected = $("option:selected", this);
        var id = this.value;
       
        if (id != ''){
          $.ajax({
            url: "{% url 'get_projects' %}",
            method: 'get',
            data: {
                'id':id,
            },
            dataType: 'json',
            success: function(data){
              console.log(data)
              if(1){
                var txt =  '<select class="form-select" id="basic-default-project" ><option selected="" disabled>...</option>'
           
                  data.data.forEach(function(item){

                  txt += '<option  value='+ item.id +'><a href=1>'+ item.name +'</a></option>'
                });
                
                
                txt += '</select>'
                $('#basic-default-project').html(txt)
               
                // txt += '</div>'
                // $('#list_camera').html(txt)
                
                // $('html,body').animate({scrollTop:distance},500);
              }
            }
          })
  
        }
        
    });

     //   Select project
 $('#basic-default-project').on('change', function (e) {
        
        var optionSelected = $("option:selected", this);
        var id = this.value;
        console.log('$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$', id)
        if (id != ''){
          $.ajax({
            url: "{% url 'get_stations' %}",
            method: 'get',
            data: {
                'id':id,
            },
            dataType: 'json',
            success: function(data){
              if(1){
                var txt =  '<select class="form-select" id="basic-default-location" ><option selected="" disabled>...</option>'
           
                  data.data.forEach(function(item){

                  txt += '<option  value='+ item.id +'><a href=1>'+ item.name +'</a></option>'
                });
                txt += '</select>'
                $('#basic-default-location').html(txt)
               
                // txt += '</div>'
                // $('#list_camera').html(txt)
                
                // $('html,body').animate({scrollTop:distance},500);
              }
            }
          })
  
        }
        
    });
  $('#basic-default-company').on('change', function (e) {
 
    var optionSelected = $("option:selected", this);
    var id = this.value;
    if (id != ''){
          $.ajax({
           
            data: {
                'id':id,
            },
            dataType: 'json',
            success: function(data){
              console.log(data)}
            })
          }

  });

  $('#basic-default-LICate').on('change', function (e) {
 
 var optionSelected = $("option:selected", this);
 var id = this.value;
 if (id != ''){
       $.ajax({
        
         data: {
             'id':id,
         },
         dataType: 'json',
         success: function(data){
           console.log(data)}
         })
       }

});
$('#basic-default-VideoFormat').on('change', function (e) {
 
 var optionSelected = $("option:selected", this);
 var id = this.value;
 if (id != ''){
       $.ajax({
        
         data: {
             'id':id,
         },
         dataType: 'json',
         success: function(data){
           console.log(data)}
         })
       }

});
// java script --- video upload ---------

$('#submit').on('click', (event) => {
  console.log("INSIDE UPLOAD SUBMIT CALL")
  event.preventDefault();
 


  var uploader = new FileUpload(document.querySelector('#fileupload'))
 
  console.log(document.querySelector('#fileupload'));
  uploader.upload();

});

class FileUpload {

  constructor(input) {
      this.input = input
      this.max_length = 1024 * 1024 * 10;
  }

  create_progress_bar() {
      var progress = `<div class="file-icon">
                          <i class="fa fa-file-o" aria-hidden="true"></i>
                      </div>
                      <div class="file-details">
                          <p class="filename"></p>
                          <small class="textbox"></small>
                          <div class="progress" style="margin-top: 5px;">
                              <div class="progress-bar bg-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                              </div>
                          </div>
                      </div>`
      document.getElementById('uploaded_files').innerHTML = progress
  }

  upload() {
      console.log("INSIDE UPLOAD FUNCTION")
      
      this.create_progress_bar();
      this.initFileUpload();
  }

  initFileUpload() {
      this.file = this.input.files[0];
      this.upload_file(0, null);
     
     
  }

  //upload file
  upload_file(start, model_id) {
    
    
      var end;
      var self = this;
      console.log("Path",model_id)
      var existingPath = model_id;
      console.log("existingPath",existingPath)
      var formData = new FormData();
      var nextChunk = start + this.max_length + 1;
      var currentChunk = this.file.slice(start, nextChunk);
      var uploadedChunk = start + currentChunk.size

      var starttime= $('#VideoStartTime').val(); 
      var endtime= $('#VideoEndTime').val(); 
      var videodate = $('#VideoTakenDate').val(); 

      var company= $('#basic-default-company').val(); 
      var project= $('#basic-default-project').val(); 
      var location= $('#basic-default-location').val(); 
      var camerano= $('#CameraNo').val(); 
      var cameraModel=$('#basic-default-cModel').val(); 
      var cameraview=$('#CView').val(); 
      var cameraheight= $('#CHeight').val(); 
     
      var LIcate= $('#basic-default-LICate').val(); 
      var videoformat= $('#basic-default-VideoFormat').val(); 
      var remarks= $('#Remarks').val(); 

      if(videodate == ''){ alert("Enter Video Taken Date")}
      if (starttime == '') { alert("Enter Video Start Time")}
      if (endtime == '' ) {alert("Enter Video End Time")}

      if (uploadedChunk >= this.file.size) {
          end = 1;
      } else {
          end = 0;
      }

    

      

      formData.append('file', currentChunk)
      formData.append('filename', this.file.name)
      $('.filename').text(this.file.name)
      $('.textbox').text("Uploading file")

      $("#submit").prop({disabled: true});

      formData.append('end', end)
      formData.append('existingPath', existingPath)
      // console.log("existingPath@222",existingPath)
      formData.append('nextSlice', nextChunk)
      formData.append('videodate',videodate)
      formData.append('starttime',starttime)
      formData.append('endtime',endtime)
      formData.append('CompanyName',company)
      formData.append('ProjectName',project)
      formData.append('StationName',location)
      formData.append('CameraNo',camerano)
      formData.append('CModel',cameraModel)
      formData.append('CHeight',cameraheight)
      formData.append('CView',cameraview)
      formData.append('LICate',LIcate)
      formData.append('VideoFormat',videoformat)
      formData.append('Remarks',remarks)

      $.ajaxSetup({
          headers: {
              "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
          }
      });
      $.ajax({
          xhr: function () {
              var xhr = new XMLHttpRequest();
              xhr.upload.addEventListener('progress', function (e) {
                  if (e.lengthComputable) {
                      if (self.file.size <= self.max_length) {
                          var percent = Math.round((e.loaded / e.total) * 100);
                      } else {
                          var percent = Math.round((uploadedChunk / self.file.size) * 100);
                      }
                      $('.progress-bar').css('width', percent + '%')
                      $('.progress-bar').text(percent + '%')
                  }
              });
              console.log("xhr function",xhr)
              return xhr;
          },

          url: '',
          type: 'POST',
          dataType: 'json',
          cache: false,
          processData: false,
          contentType: false,
          data: formData,
          error: function (xhr) {
              alert(xhr.ResponseText);
              console.log("error part")
              $('#fileupload input').val("");
          },
          success: function (res) {
              console.log("RES RES",res)
              if (nextChunk <= self.file.size) {
                  // upload file in chunks

                  existingPath = res.existingPath
                  console.log("Existing path :",existingPath)
                  self.upload_file(nextChunk, existingPath);
              } else {
                  // upload complete
                 
                  console.log("else part check file size")
                  $('.textbox').text(res.data);
                  VideoUpload.reset()
                  
                  alert(res.data)
                  $('.textbox').text("");
                  document.getElementById('uploaded_files').innerHTML=""
                  $("#submit").prop({disabled: false});
                
                  
                 
              }
          }
      

         
      });
  };
}
{% comment %} (function ($) {
  $('#submit').on('click', (event) => {
      event.preventDefault();
      var uploader = new FileUpload(document.querySelector('#fileupload'))
      console.log(document.querySelector('#fileupload'));
      uploader.upload();
    
  });
})(jQuery); {% endcomment %}
</script>
{% endblock %}
